import type MarkdownIt from 'markdown-it'
import type StateInline from 'markdown-it/lib/rules_inline/state_inline.mjs'

// Common emoji definitions (200+ emojis)
// Organized by category for easier maintenance
const EMOJI_MAP = new Map<string, string>([
  ['grinning', 'ğŸ˜€'],
  ['smiley', 'ğŸ˜ƒ'],
  ['smile', 'ğŸ˜„'],
  ['grin', 'ğŸ˜'],
  ['laughing', 'ğŸ˜†'],
  ['satisfied', 'ğŸ˜†'],
  ['sweat_smile', 'ğŸ˜…'],
  ['joy', 'ğŸ˜‚'],
  ['wink', 'ğŸ˜‰'],
  ['blush', 'ğŸ˜Š'],
  ['innocent', 'ğŸ˜‡'],
  ['heart_eyes', 'ğŸ˜'],
  ['kissing_heart', 'ğŸ˜˜'],
  ['kissing', 'ğŸ˜—'],
  ['kissing_closed_eyes', 'ğŸ˜š'],
  ['kissing_smiling_eyes', 'ğŸ˜™'],
  ['yum', 'ğŸ˜‹'],
  ['stuck_out_tongue', 'ğŸ˜›'],
  ['stuck_out_tongue_winking_eye', 'ğŸ˜œ'],
  ['stuck_out_tongue_closed_eyes', 'ğŸ˜'],
  ['neutral_face', 'ğŸ˜'],
  ['expressionless', 'ğŸ˜‘'],
  ['no_mouth', 'ğŸ˜¶'],
  ['smirk', 'ğŸ˜'],
  ['unamused', 'ğŸ˜’'],
  ['relieved', 'ğŸ˜Œ'],
  ['pensive', 'ğŸ˜”'],
  ['sleepy', 'ğŸ˜ª'],
  ['sleeping', 'ğŸ˜´'],
  ['mask', 'ğŸ˜·'],
  ['dizzy_face', 'ğŸ˜µ'],
  ['sunglasses', 'ğŸ˜'],
  ['confused', 'ğŸ˜•'],
  ['worried', 'ğŸ˜Ÿ'],
  ['open_mouth', 'ğŸ˜®'],
  ['hushed', 'ğŸ˜¯'],
  ['astonished', 'ğŸ˜²'],
  ['flushed', 'ğŸ˜³'],
  ['frowning', 'ğŸ˜¦'],
  ['anguished', 'ğŸ˜§'],
  ['fearful', 'ğŸ˜¨'],
  ['cold_sweat', 'ğŸ˜°'],
  ['disappointed_relieved', 'ğŸ˜¥'],
  ['cry', 'ğŸ˜¢'],
  ['sob', 'ğŸ˜­'],
  ['scream', 'ğŸ˜±'],
  ['confounded', 'ğŸ˜–'],
  ['persevere', 'ğŸ˜£'],
  ['disappointed', 'ğŸ˜'],
  ['sweat', 'ğŸ˜“'],
  ['weary', 'ğŸ˜©'],
  ['tired_face', 'ğŸ˜«'],
  ['triumph', 'ğŸ˜¤'],
  ['rage', 'ğŸ˜¡'],
  ['angry', 'ğŸ˜ '],
  ['smiling_imp', 'ğŸ˜ˆ'],
  ['imp', 'ğŸ‘¿'],
  ['skull', 'ğŸ’€'],
  ['eyes', 'ğŸ‘€'],
  ['eye', 'ğŸ‘ï¸'],
  ['nose', 'ğŸ‘ƒ'],
  ['lips', 'ğŸ‘„'],
  ['tongue', 'ğŸ‘…'],
  ['heart', 'â¤ï¸'],
  ['yellow_heart', 'ğŸ’›'],
  ['green_heart', 'ğŸ’š'],
  ['blue_heart', 'ğŸ’™'],
  ['purple_heart', 'ğŸ’œ'],
  ['broken_heart', 'ğŸ’”'],
  ['thumbsup', 'ğŸ‘'],
  ['+1', 'ğŸ‘'],
  ['thumbsdown', 'ğŸ‘'],
  ['-1', 'ğŸ‘'],
  ['ok_hand', 'ğŸ‘Œ'],
  ['facepunch', 'ğŸ‘Š'],
  ['punch', 'ğŸ‘Š'],
  ['fist', 'âœŠ'],
  ['v', 'âœŒï¸'],
  ['wave', 'ğŸ‘‹'],
  ['hand', 'âœ‹'],
  ['raised_hand', 'âœ‹'],
  ['clap', 'ğŸ‘'],
  ['pray', 'ğŸ™'],
  ['point_up', 'â˜ï¸'],
  ['point_down', 'ğŸ‘‡'],
  ['point_left', 'ğŸ‘ˆ'],
  ['point_right', 'ğŸ‘‰'],
  ['raised_hands', 'ğŸ™Œ'],
  ['muscle', 'ğŸ’ª'],
  ['writing_hand', 'âœï¸'],
  ['nail_care', 'ğŸ’…'],
  ['selfie', 'ğŸ¤³'],
  ['fire', 'ğŸ”¥'],
  ['sparkles', 'âœ¨'],
  ['star', 'â­'],
  ['star2', 'ğŸŒŸ'],
  ['zap', 'âš¡'],
  ['boom', 'ğŸ’¥'],
  ['collision', 'ğŸ’¥'],
  ['100', 'ğŸ’¯'],
  ['tada', 'ğŸ‰'],
  ['confetti_ball', 'ğŸŠ'],
  ['balloon', 'ğŸˆ'],
  ['gift', 'ğŸ'],
  ['birthday', 'ğŸ‚'],
  ['cake', 'ğŸ°'],
  ['rocket', 'ğŸš€'],
  ['helicopter', 'ğŸš'],
  ['airplane', 'âœˆï¸'],
  ['boat', 'â›µ'],
  ['ship', 'ğŸš¢'],
  ['train', 'ğŸš‚'],
  ['bus', 'ğŸšŒ'],
  ['taxi', 'ğŸš•'],
  ['car', 'ğŸš—'],
  ['bike', 'ğŸš²'],
  ['checkered_flag', 'ğŸ'],
  ['medal', 'ğŸ…'],
  ['trophy', 'ğŸ†'],
  ['medal_sports', 'ğŸ…'],
  ['medal_military', 'ğŸ–ï¸'],
  ['soccer', 'âš½'],
  ['basketball', 'ğŸ€'],
  ['football', 'ğŸˆ'],
  ['baseball', 'âš¾'],
  ['tennis', 'ğŸ¾'],
  ['bowling', 'ğŸ³'],
  ['golf', 'â›³'],
  ['dart', 'ğŸ¯'],
  ['beer', 'ğŸº'],
  ['beers', 'ğŸ»'],
  ['wine_glass', 'ğŸ·'],
  ['cocktail', 'ğŸ¸'],
  ['coffee', 'â˜•'],
  ['pizza', 'ğŸ•'],
  ['hamburger', 'ğŸ”'],
  ['fries', 'ğŸŸ'],
  ['apple', 'ğŸ'],
  ['banana', 'ğŸŒ'],
  ['watermelon', 'ğŸ‰'],
  ['grapes', 'ğŸ‡'],
  ['strawberry', 'ğŸ“'],
  ['cherries', 'ğŸ’'],
  ['lemon', 'ğŸ‹'],
  ['peach', 'ğŸ‘'],
  ['pear', 'ğŸ'],
  ['pineapple', 'ğŸ'],
  ['tomato', 'ğŸ…'],
  ['eggplant', 'ğŸ†'],
  ['hot_pepper', 'ğŸŒ¶ï¸'],
  ['corn', 'ğŸŒ½'],
  ['bread', 'ğŸ'],
  ['croissant', 'ğŸ¥'],
  ['baguette_bread', 'ğŸ¥–'],
  ['cheese', 'ğŸ§€'],
  ['egg', 'ğŸ¥š'],
  ['poultry_leg', 'ğŸ—'],
  ['meat_on_bone', 'ğŸ–'],
  ['doughnut', 'ğŸ©'],
  ['cookie', 'ğŸª'],
  ['chocolate_bar', 'ğŸ«'],
  ['candy', 'ğŸ¬'],
  ['lollipop', 'ğŸ­'],
  ['ice_cream', 'ğŸ¦'],
  ['icecream', 'ğŸ¨'],
  ['shaved_ice', 'ğŸ§'],
  ['tea', 'ğŸµ'],
  ['sake', 'ğŸ¶'],
  ['champagne', 'ğŸ¾'],
  ['tropical_drink', 'ğŸ¹'],
  ['sunny', 'â˜€ï¸'],
  ['cloud', 'â˜ï¸'],
  ['umbrella', 'â˜‚ï¸'],
  ['snowflake', 'â„ï¸'],
  ['snowman', 'â›„'],
  ['rainbow', 'ğŸŒˆ'],
  ['ocean', 'ğŸŒŠ'],
  ['droplet', 'ğŸ’§'],
  ['zap', 'âš¡'],
  ['fire', 'ğŸ”¥'],
  ['star', 'â­'],
  ['moon', 'ğŸŒ™'],
  ['partly_sunny', 'â›…'],
  ['thunder_cloud_and_rain', 'â›ˆï¸'],
  ['wind_face', 'ğŸŒ¬ï¸'],
  ['fog', 'ğŸŒ«ï¸'],
  ['dog', 'ğŸ¶'],
  ['cat', 'ğŸ±'],
  ['mouse', 'ğŸ­'],
  ['rabbit', 'ğŸ°'],
  ['fox_face', 'ğŸ¦Š'],
  ['bear', 'ğŸ»'],
  ['panda_face', 'ğŸ¼'],
  ['koala', 'ğŸ¨'],
  ['tiger', 'ğŸ¯'],
  ['lion', 'ğŸ¦'],
  ['cow', 'ğŸ®'],
  ['pig', 'ğŸ·'],
  ['frog', 'ğŸ¸'],
  ['monkey_face', 'ğŸµ'],
  ['see_no_evil', 'ğŸ™ˆ'],
  ['hear_no_evil', 'ğŸ™‰'],
  ['speak_no_evil', 'ğŸ™Š'],
  ['chicken', 'ğŸ”'],
  ['penguin', 'ğŸ§'],
  ['bird', 'ğŸ¦'],
  ['baby_chick', 'ğŸ¤'],
  ['bee', 'ğŸ'],
  ['bug', 'ğŸ›'],
  ['butterfly', 'ğŸ¦‹'],
  ['snail', 'ğŸŒ'],
  ['turtle', 'ğŸ¢'],
  ['snake', 'ğŸ'],
  ['lizard', 'ğŸ¦'],
  ['dragon', 'ğŸ‰'],
  ['whale', 'ğŸ³'],
  ['dolphin', 'ğŸ¬'],
  ['fish', 'ğŸŸ'],
  ['octopus', 'ğŸ™'],
  ['shell', 'ğŸš'],
  ['crab', 'ğŸ¦€'],
  ['tree', 'ğŸŒ²'],
  ['evergreen_tree', 'ğŸŒ²'],
  ['deciduous_tree', 'ğŸŒ³'],
  ['palm_tree', 'ğŸŒ´'],
  ['cactus', 'ğŸŒµ'],
  ['herb', 'ğŸŒ¿'],
  ['shamrock', 'â˜˜ï¸'],
  ['four_leaf_clover', 'ğŸ€'],
  ['maple_leaf', 'ğŸ'],
  ['fallen_leaf', 'ğŸ‚'],
  ['leaves', 'ğŸƒ'],
  ['mushroom', 'ğŸ„'],
  ['cherry_blossom', 'ğŸŒ¸'],
  ['rose', 'ğŸŒ¹'],
  ['hibiscus', 'ğŸŒº'],
  ['sunflower', 'ğŸŒ»'],
  ['blossom', 'ğŸŒ¼'],
  ['bouquet', 'ğŸ’'],
  ['seedling', 'ğŸŒ±'],
  ['christmas_tree', 'ğŸ„'],
  ['santa', 'ğŸ…'],
  ['gift_heart', 'ğŸ’'],
  ['ring', 'ğŸ’'],
  ['gem', 'ğŸ’'],
  ['bulb', 'ğŸ’¡'],
  ['book', 'ğŸ“–'],
  ['pencil', 'ğŸ“'],
  ['memo', 'ğŸ“'],
  ['email', 'âœ‰ï¸'],
  ['envelope', 'âœ‰ï¸'],
  ['phone', 'â˜ï¸'],
  ['telephone', 'â˜ï¸'],
  ['iphone', 'ğŸ“±'],
  ['camera', 'ğŸ“·'],
  ['video_camera', 'ğŸ“¹'],
  ['tv', 'ğŸ“º'],
  ['computer', 'ğŸ’»'],
  ['keyboard', 'âŒ¨ï¸'],
  ['desktop_computer', 'ğŸ–¥ï¸'],
  ['printer', 'ğŸ–¨ï¸'],
  ['mouse', 'ğŸ–±ï¸'],
  ['trackball', 'ğŸ–²ï¸'],
  ['joystick', 'ğŸ•¹ï¸'],
  ['watch', 'âŒš'],
  ['alarm_clock', 'â°'],
  ['stopwatch', 'â±ï¸'],
  ['timer_clock', 'â²ï¸'],
  ['hourglass', 'âŒ›'],
  ['hourglass_flowing_sand', 'â³'],
  ['satellite_antenna', 'ğŸ“¡'],
  ['battery', 'ğŸ”‹'],
  ['electric_plug', 'ğŸ”Œ'],
  ['lock', 'ğŸ”’'],
  ['unlock', 'ğŸ”“'],
  ['key', 'ğŸ”‘'],
  ['mag', 'ğŸ”'],
  ['mag_right', 'ğŸ”'],
  ['bell', 'ğŸ””'],
  ['no_bell', 'ğŸ”•'],
  ['bookmark', 'ğŸ”–'],
  ['link', 'ğŸ”—'],
  ['wrench', 'ğŸ”§'],
  ['hammer', 'ğŸ”¨'],
  ['nut_and_bolt', 'ğŸ”©'],
  ['thinking', 'ğŸ¤”'],
  ['thinking_face', 'ğŸ¤”'],
  ['question', 'â“'],
  ['grey_question', 'â”'],
  ['exclamation', 'â—'],
  ['grey_exclamation', 'â•'],
  ['warning', 'âš ï¸'],
  ['x', 'âŒ'],
  ['o', 'â­•'],
  ['white_check_mark', 'âœ…'],
  ['heavy_check_mark', 'âœ”ï¸'],
  ['accept', 'ğŸ‰‘'],
  ['satellite', 'ğŸ“¡'],
  ['arrow_up', 'â¬†ï¸'],
  ['arrow_down', 'â¬‡ï¸'],
  ['arrow_left', 'â¬…ï¸'],
  ['arrow_right', 'â¡ï¸'],
  ['arrow_upper_right', 'â†—ï¸'],
  ['arrow_lower_right', 'â†˜ï¸'],
  ['arrow_lower_left', 'â†™ï¸'],
  ['arrow_upper_left', 'â†–ï¸'],
  ['arrow_up_down', 'â†•ï¸'],
  ['left_right_arrow', 'â†”ï¸'],
  ['arrows_counterclockwise', 'ğŸ”„'],
  ['back', 'ğŸ”™'],
  ['end', 'ğŸ”š'],
  ['on', 'ğŸ”›'],
  ['soon', 'ğŸ”œ'],
  ['top', 'ğŸ”'],
  ['red_circle', 'ğŸ”´'],
  ['blue_circle', 'ğŸ”µ'],
  ['white_circle', 'âšª'],
  ['black_circle', 'âš«'],
  ['red_square', 'ğŸŸ¥'],
  ['blue_square', 'ğŸŸ¦'],
  ['white_square', 'â¬œ'],
  ['black_square', 'â¬›'],
  ['orange_square', 'ğŸŸ§'],
  ['yellow_square', 'ğŸŸ¨'],
  ['green_square', 'ğŸŸ©'],
  ['purple_square', 'ğŸŸª'],
  ['brown_square', 'ğŸŸ«'],
  ['diamond_shape_with_a_dot_inside', 'ğŸ’ '],
  ['radio_button', 'ğŸ”˜'],
  ['white_square_button', 'ğŸ”³'],
  ['black_square_button', 'ğŸ”²'],
  ['scissors', 'âœ‚ï¸'],
  ['paperclip', 'ğŸ“'],
  ['pushpin', 'ğŸ“Œ'],
  ['round_pushpin', 'ğŸ“'],
  ['triangular_flag_on_post', 'ğŸš©'],
  ['closed_book', 'ğŸ“•'],
  ['open_book', 'ğŸ“–'],
  ['green_book', 'ğŸ“—'],
  ['blue_book', 'ğŸ“˜'],
  ['orange_book', 'ï¿½orange_book'],
  ['notebook', 'ğŸ““'],
  ['ledger', 'ğŸ“’'],
  ['page_with_curl', 'ğŸ“ƒ'],
  ['scroll', 'ğŸ“œ'],
  ['page_facing_up', 'ğŸ“„'],
  ['newspaper', 'ğŸ“°'],
  ['bookmark_tabs', 'ğŸ“‘'],
  ['bar_chart', 'ğŸ“Š'],
  ['chart_with_upwards_trend', 'ğŸ“ˆ'],
  ['chart_with_downwards_trend', 'ğŸ“‰'],
  ['calendar', 'ğŸ“…'],
  ['date', 'ğŸ“†'],
  ['clipboard', 'ğŸ“‹'],
  ['file_folder', 'ğŸ“'],
  ['open_file_folder', 'ğŸ“‚'],
  ['briefcase', 'ğŸ’¼'],
  ['package', 'ğŸ“¦'],
  ['inbox_tray', 'ğŸ“¥'],
  ['outbox_tray', 'ğŸ“¤'],
  ['musical_note', 'ğŸµ'],
  ['notes', 'ğŸ¶'],
  ['microphone', 'ğŸ¤'],
  ['headphones', 'ğŸ§'],
  ['guitar', 'ğŸ¸'],
  ['trumpet', 'ğŸº'],
  ['saxophone', 'ğŸ·'],
  ['violin', 'ğŸ»'],
  ['drum', 'ğŸ¥'],
  ['clapper', 'ğŸ¬'],
  ['art', 'ğŸ¨'],
  ['performing_arts', 'ğŸ­'],
  ['game_die', 'ğŸ²'],
  ['slot_machine', 'ğŸ°'],
])

/**
 * Emoji parser for markdown-it
 * Only supports :emoji_name: syntax (no shortcuts/emoticons)
 * Uses Map for O(1) lookups and simple string scanning
 */
function emojiRule(state: StateInline, silent: boolean): boolean {
  const max = state.posMax
  const start = state.pos

  // Quick check: must start with ':'
  if (state.src.charCodeAt(start) !== 0x3A /* : */) {
    return false
  }

  // Find the closing ':'
  let pos = start + 1
  while (pos < max) {
    const code = state.src.charCodeAt(pos)

    // Found closing ':'
    if (code === 0x3A /* : */) {
      const emojiName = state.src.slice(start + 1, pos)

      // Check if this is a valid emoji
      const emojiChar = EMOJI_MAP.get(emojiName)
      if (emojiChar) {
        if (!silent) {
          const token = state.push('emoji', '', 0)
          token.markup = emojiName
          token.content = emojiChar
        }
        state.pos = pos + 1
        return true
      }

      // Not a valid emoji, stop searching
      return false
    }

    // Only allow word characters, digits, underscores, hyphens, and plus
    // This matches the pattern of valid emoji names
    if (
      (code >= 0x61 && code <= 0x7A) // a-z
      || (code >= 0x41 && code <= 0x5A) // A-Z
      || (code >= 0x30 && code <= 0x39) // 0-9
      || code === 0x5F // _
      || code === 0x2D // -
      || code === 0x2B // +
    ) {
      pos++
      continue
    }

    // Invalid character in emoji name
    return false
  }

  // No closing ':' found
  return false
}

export default function markdownItEmoji(md: MarkdownIt): void {
  md.inline.ruler.before('emphasis', 'emoji', emojiRule)
}
